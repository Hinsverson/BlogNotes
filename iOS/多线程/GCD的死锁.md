# GCDçš„æ­»é”
#iOSçŸ¥è¯†ç‚¹/å¤šçº¿ç¨‹

è¯´äººè¯ï¼Œè¿˜æ˜¯ç›´æ¥ä¸¾ä¸ªğŸŒ°çœ‹ä¸ªé—®é¢˜å§ï¼Œè¯·é—®åœ¨ä¸»çº¿ç¨‹è°ƒç”¨ä¸‹é¢æ–¹æ³•çš„æ‰§è¡Œé¡ºåºï¼Ÿ

è¿½åŠ é—®é¢˜1ï¼šæ‰§è¡Œæ—¶ä¼šå‘ç”Ÿæ­»é”å—ï¼Œä¸ºä»€ä¹ˆï¼Ÿ

è¿½åŠ é—®é¢˜2ï¼šæ‰§è¡Œæ—¶ä¼šå´©æºƒå—ï¼Œä¸ºä»€ä¹ˆï¼Ÿ

```swift
func deadLock4() {
    print("1")
    let que = DispatchQueue.init(label: "thread")
    que.async {
        print("2")
        DispatchQueue.main.sync { 
            print("3")
            que.sync {
                print("4")
            }
        }
        print("5")
    }
    print("6")
    que.async {
        print("7")
    }
    print("8")
}
```
æ­£ç¡®ç­”æ¡ˆæ˜¯è¾“å‡º1ã€2å’Œ(68)é¡ºåºä¸å›ºå®šã€3ã€queé˜Ÿåˆ—å¾ªç¯ç­‰å¾…é˜»å¡é€ æˆæ­»é”ï¼Œä½†å¹¶ä¸ä¼šå´©æºƒã€‚

å¦‚æœèƒ½å‡†ç¡®è¯´å‡ºæ‰§è¡Œé¡ºåºå¹¶ç†è§£ä¸ºä»€ä¹ˆæ­»é”è€Œä¸å´©ï¼Œåé¢çš„å†…å®¹å¯ä»¥ä¸ç”¨çœ‹äº†ï¼Œå¦‚æœå¿ƒä¸­è¿˜æœ‰ç–‘è™‘ï¼Œæ¨¡æ£±ä¸¤å¯ï¼Œè¿™å°±æ˜¯è¿™ç¯‡æ–‡ç« çš„ç›®çš„ï¼Œå¾€åçœ‹ğŸ‘‡ğŸ‘‡å…ˆç†è§£è§£å†³æ‰§è¡Œé¡ºåºé—®é¢˜ï¼Œå†è§£å†³æ­»é”é—®é¢˜ã€‚

# GCDæ ¸å¿ƒ
è‡ªåŠ¨çš„æ ¹æ®å¤šæ ¸CPUçš„ä½¿ç”¨æƒ…å†µï¼Œåˆ›å»ºçº¿ç¨‹æ± æŠ½è±¡æˆqueueæ¥æ‰§è¡Œä»»åŠ¡ï¼Œæé«˜ç¨‹åºçš„è¿è¡Œæ•ˆç‡ã€‚

## é˜Ÿåˆ—ç±»å‹ï¼šå†³å®šä»»åŠ¡æ€æ ·æ‹¿å‡ºæ¥å’Œæ”¾ç½®
* ä¸²è¡Œé˜Ÿåˆ—ï¼šä»»åŠ¡åªèƒ½ä¸€ä¸ªä¸€ä¸ªæ‹¿å‡ºæ¥é¡ºåºçš„åœ¨å”¯ä¸€çš„ä¸€æ¡çº¿ç¨‹ä¸Šæ‰§è¡Œã€‚
* å¹¶è¡Œé˜Ÿåˆ—ï¼šå¯ä»¥åŒæ—¶æ‹¿å‡ºå¤šä¸ªä»»åŠ¡åˆ°ä¸åŒçš„çº¿ç¨‹å¹¶å‘æ‰§è¡Œã€‚

## ä»»åŠ¡æ‰§è¡Œæ–¹å¼ï¼šå†³å®šæ‹¿å‡ºæ¥çš„ä»»åŠ¡åœ¨å“ªæ¡çº¿ç¨‹ä¸Šæ‰§è¡Œï¼Œä»¥åŠé˜»ä¸é˜»å¡å½“å‰çº¿ç¨‹
syncåŒæ­¥ï¼šä¸å…·å¤‡å¼€å¯æ–°çº¿ç¨‹çš„èƒ½åŠ›ï¼Œåœ¨å½“å‰ä¸Šä¸‹æ–‡çº¿ç¨‹ä¸­æ‰§è¡Œï¼Œå¹¶é˜»å¡ã€‚
asyncå¼‚æ­¥ï¼šå…·å¤‡å¼€å¯æ–°çº¿ç¨‹çš„èƒ½åŠ›ï¼Œä¸²è¡Œé˜Ÿåˆ—å¤šä¸ªå¼‚æ­¥åªä¼šå¼€å¯ä¸€ä¸ªçº¿ç¨‹ï¼Œä¸»é˜Ÿåˆ—å·²ç»å­˜åœ¨ä¸»çº¿ç¨‹ï¼Œæ‰€ä»¥å¼‚æ­¥ä¹Ÿä¸ä¼šå¼€å¯ï¼Œå¹¶è¡Œé˜Ÿåˆ—å¹¶å‘å¼€å¯çº¿ç¨‹æ‰§è¡Œï¼Œæœ€å¤š64æ¡ï¼Œä¸é˜»å¡ã€‚

::main queueç‰¹æ®Šæ³¨æ„ç‚¹ï¼š::
1. main queueæ˜¯ä¸²è¡Œé˜Ÿåˆ—ï¼Œå¹¶ä¸”å·²ç»å­˜åœ¨æœ‰å¯¹åº”çš„ä¸»çº¿ç¨‹ï¼Œæ‰€ä»¥ä¸»é˜Ÿåˆ—asyncæ·»åŠ ä»»åŠ¡ä¸ä¼šå¼€å¯æ–°çº¿ç¨‹ã€‚
2. æ— è®ºæ˜¯ç”¨è¿‡syncã€asyncå‘main queueæäº¤ä»»åŠ¡éƒ½åœ¨ä¸»çº¿ç¨‹æ‰§è¡Œã€‚

# æ‰§è¡Œé¡ºåºé—®é¢˜
1. é¦–å…ˆæ˜¯æ˜ç¡®é˜»ä¸é˜»å¡å½“å‰çº¿ç¨‹ï¼Œé˜»å¡å¯ä»¥ç†è§£ä¸ºå½“å‰çº¿ç¨‹æ²¡æœ‰æäº¤åé¢ä»»åŠ¡å’Œæ‰§è¡Œçš„èƒ½åŠ›äº†ã€‚
2. å…¶æ¬¡è¦æ˜ç¡®ä»»åŠ¡æ˜¯åœ¨å“ªä¸ªçº¿ç¨‹ä¸Šæ‰§è¡Œçš„ï¼Œå¦‚æœä»»åŠ¡æ˜¯åˆ†åˆ«åœ¨ä¸åŒçº¿ç¨‹æ‰§è¡Œï¼Œé‚£ä¹ˆé¡ºåºå¯èƒ½ä¸ä¸€å®šã€‚

```swift
// è¾“å‡ºï¼š1 2 5 4 6 3 8ï¼ˆå¿…å®šï¼‰
// å…¨éƒ¨éƒ½åœ¨ä¸»çº¿ç¨‹æ‰§è¡Œ
func test1() { //task
    print("1") 
    DispatchQueue.global().sync { //task1
        print("2")
        print("5")
        DispatchQueue.main.async { //task2
            Thread.sleep(forTimeInterval: 0.2)
            print("3")
        }
    }
    DispatchQueue.main.async { //task3
        print("8")
    }
    // è¿™é‡Œåé¢çš„æ‰€æœ‰è¦çœ‹æˆä¸€ä¸ªæ•´ä½“
    print("4")
    Thread.sleep(forTimeInterval: 0.2)
    print("6")
}
```
* å› ä¸ºsyncé˜»å¡å½“å‰çº¿ç¨‹mainæäº¤task1ï¼Œæ‰€ä»¥å¤–éƒ¨1ã€4ã€6å…±åŒç»„æˆçš„taskè¦æ•´ä½“æ‰§è¡Œå®Œçš„è¯ä¾èµ–äºtask1ã€‚
* å½“2å’Œ5æ‰§è¡Œä¹‹åï¼Œç”±äºasyncå¼‚æ­¥æäº¤task2ï¼Œä¸é˜»å¡task1çš„æ‰§è¡Œçº¿ç¨‹mainï¼Œæ‰€ä»¥task1å®Œæˆï¼Œæ‰€ä»¥125åç›´æ¥46ï¼Œå³ä½¿sleep mainï¼Œå› ä¸ºtaskæ˜¯æœ€å…ˆå­˜åœ¨äºé˜Ÿåˆ—ä¸­çš„ï¼Œä¸²è¡Œé˜Ÿåˆ—åªèƒ½ä¸€ä¸ªä¸€ä¸ªæ‹¿å‡ºæ¥æ‰§è¡Œã€‚
* åŒæ ·task2çš„æäº¤æ¯”task3æ—©ï¼Œæ‰€ä»¥å…ˆæ‰§è¡Œtask2ï¼Œå†æ‰§è¡Œtask3ã€‚

## åƒğŸŒ°
``` swift
// 1å’Œ2çš„é¡ºåºä¸å›ºå®šï¼Œ2æ‰§è¡Œå®Œåæ‰æ‰§è¡Œ3å’Œ4ï¼Œ3å’Œ4çš„é¡ºåºä¸å›ºå®š
func test2() {
    DispatchQueue.global().async {
        print("1")
    }
    DispatchQueue.global().sync {
        print("2")
    }
    DispatchQueue.global().async {
        print("3")
    }
    print("4")
}
// 1ã€2å’Œ3çš„é¡ºåºä¸å›ºå®šã€3è‚¯å®šåœ¨4çš„å‰é¢
func test3() {
    DispatchQueue.global().sync {
        print("1")
    }
    DispatchQueue.global().async {
        print("2")
    }
    DispatchQueue.global().sync {
        print("3")
    }
    print("4")
}
// 1å’Œ2æ‰§è¡Œä¸å›ºå®šï¼Œä½†æ˜¯3è‚¯å®šåœ¨1å’Œ2çš„åé¢
func test4() {
    let que = DispatchQueue.init(label: "thread")
    que.async {
        print("1")
    }
    print("2")
    que.sync { 
        print("3")
    }
}
// 1ã€2å’Œ5ä¸å›ºå®šï¼Œ34ä¸æ‰“å°
// è¿™ç§ä¸¥æ ¼æ„ä¹‰ä¸Šæ¥è¯´æ˜¯ä¸æ˜¯ä»€ä¹ˆé˜»å¡ï¼Œåªæ˜¯å¤–éƒ¨taskä¸€ç›´æ²¡æ‰§è¡Œå®Œä¸€ç›´æ²¡å‡ºé˜Ÿ
func deadLock() { //task
    print("1")
    DispatchQueue.global().async {
        print("2")
        DispatchQueue.main.sync { //ä¸»çº¿ç¨‹æ‰§è¡Œ
            print("3")
        }
        print("4")
    }
    print("5")
    while true {
    }
}
```

# æ­»é”å’Œå´©æºƒçš„é—®é¢˜
æ­»é”çš„å‘ç”Ÿï¼šä¸²è¡Œé˜Ÿåˆ—å†…ä»»åŠ¡çš„äº’ç›¸ä¾èµ–ç­‰å¾…é˜»å¡å¯¼è‡´æ­»é”ã€‚
å¥”æºƒçš„åŸå› ï¼šå…ˆå‰çš„ä¸²è¡Œqueueè¢«æŸä¸ªtaskAç”¨æ‰§è¡Œæ—¶æ‰€åœ¨çº¿ç¨‹çš„tidğŸ”’ä½ï¼Œä¹‹åè¿˜æ²¡ç­‰taskAæ‰§è¡Œå®Œå¹¶æ”¾å¼€queueçš„ğŸ”’ï¼Œå†å‘å®ƒsyncæäº¤taskBæ—¶ä¼šè¿›è¡Œæ­»é”æ£€æŸ¥ï¼Œå¦‚æœtaskBæ‰§è¡Œçº¿ç¨‹tidå’ŒåŸæ¥queueä¸Šçš„tidğŸ”’ç›¸åŒå°±ä¼šæ­»ğŸ”’ï¼ŒåŒæ—¶ä¼šè¢«æ£€æµ‹å‡ºæ¥å¹¶å´©æºƒã€‚

## æºç ç†è§£ï¼š
```C++
dispatch_barrier_sync_f() {
  // å–æ‰§è¡Œçº¿ç¨‹çš„tid
	dispatch_tid tid = _dispatch_tid_self();
	if (unlikely(!_dispatch_queue_try_acquire_barrier_sync(dq, tid))) {
		// ç­‰å¾…å¹¶é˜»å¡å½“å‰çº¿ç¨‹
		return _dispatch_sync_f_slow(); 
	}
}
_dispatch_sync_f_slow() {
	_dispatch_sync_wait();
}
_dispatch_sync_wait() {
  // è¿™é‡Œä¹‹åä¼šæ£€æŸ¥æ­»é”
  dq_state = _dispatch_sync_wait_prepare(dq);
	_dispatch_lock_is_locked_by(dq_state, tid)
}
// å¼‚æˆ–è¿ç®—ï¼šè¯´æ˜å¦‚æœdq_stateå’Œå½“å‰æ‰§è¡Œçº¿ç¨‹çš„tidç›¸ç­‰åˆ™å´©æºƒ
_dispatch_lock_is_locked_by(lock_value, tid) {
	return ((lock_value ^ tid) & DLOCK_OWNER_MASK) == 0;
}
```
è¯´äººè¯ï¼šå¦‚æœ_dispatch_queue_try_acquire_barrier_syncè¿”å›falseçš„è¯ï¼Œå°±ä¼šè¿›å…¥åˆ°_dispatch_sync_f_slowä¸­ç­‰å¾…å¹¶é˜»å¡å½“å‰çº¿ç¨‹ï¼Œæˆ–è€…è¯´ç­‰å¾…ä¸²è¡Œé˜Ÿåˆ—ä¸­ä¸Šä¸€ä¸ªä»»åŠ¡æ‰§è¡Œå®Œæ¯•ã€‚åŒæ—¶å¦‚æœdq_stateå’Œå½“å‰æ‰§è¡Œçº¿ç¨‹çš„tidç›¸ç­‰åˆ™å´©æºƒã€‚

ä»å“ªé‡Œæ‹¿dq_stateï¼Ÿçœ‹ä¸‹é¢ğŸ‘‡ğŸ‘‡
``` C++
_dispatch_queue_try_acquire_barrier_sync(dispatch_queue_t dq, uint32_t tid)
{
	uint64_t init  = DISPATCH_QUEUE_STATE_INIT_VALUE(dq->dq_width);
	uint64_t value = DISPATCH_QUEUE_WIDTH_FULL_BIT | DISPATCH_QUEUE_IN_BARRIER |
			_dispatch_lock_value_from_tid(tid);
	uint64_t old_state, new_state;
	return os_atomic_rmw_loop2o(dq, dq_state, old_state, new_state, acquire, {
		uint64_t role = old_state & DISPATCH_QUEUE_ROLE_MASK;
		if (old_state != (init | role)) { 
			os_atomic_rmw_loop_give_up(break);
		}
		new_state = value | role;
	});
}
```
è¯´äººè¯ï¼Œå°±æ˜¯å–dq_stateæ—¶ï¼ˆæœ€å¥½ä»”ç»†çœ‹çœ‹å®˜æ–¹æºç ï¼‰ï¼š
* å¦‚æœè¿™ä¸ªdq_stateæ²¡è¢«æ”¹æ˜¯åˆå§‹å€¼ï¼Œä¼šè®¾ç½®ä¸ºtidè¿”å›trueï¼Œ ç›¸å½“äºæ ‡è®°äº†å½“å‰çš„queueå·²ç»è¢«ï¼ˆtidï¼‰è¿™ä¸ªçº¿ç¨‹lockäº†ã€‚
* å¦‚æœdq_stateå·²ç»è¢«ä¿®æ”¹è¿‡äº†, åˆ™ç›´æ¥è¿”å›falseã€‚

## æ·±å…¥ä¸¾ä¸ªç®€å•ğŸŒ°ï¼š
```swift
// è¿™ç§æœ€å¸¸è§çš„å¾ªç¯ç­‰å¾…é˜»å¡æ­»é”ï¼Œç›´æ¥å´©æºƒ
func deadLock1() { //task tidï¼šä¸»çº¿ç¨‹
    DispatchQueue.main.sync { //task1 tidï¼šä¸»çº¿ç¨‹
        print("1")
    }
}
// mainå¾ªç¯ç­‰å¾…é˜»å¡æ­»é”ï¼Œç›´æ¥å´©æºƒ
//âš ï¸ï¼šå¦‚æœç”¨async ä¸ä¼šæ­»é”å´©æºƒ
func deadLock2() { //task ä¸»çº¿ç¨‹
    let que = DispatchQueue.init(label: "thread")
    que.sync { //task1ä¸»çº¿ç¨‹ //âš ï¸ï¼šå¦‚æœç”¨async
        DispatchQueue.main.sync {  //task2ä¸»çº¿ç¨‹
			  print("1") 
		  }
    }
}
```
ä¸‹é¢å‡½æ•°éƒ½åœ¨ä¸»çº¿ç¨‹ä¸­è°ƒç”¨ï¼Œè°ƒç”¨ä¹Ÿæ˜¯ä¸€ä¸ªtaskï¼Œå‘ç”Ÿæ­»é”å´©æºƒåŸå› å¦‚ä¸‹ï¼š
1. åœ¨è°ƒç”¨å‡½æ•°å‰ï¼Œmain queueå·²ç»åœ¨æ‰§è¡Œtaskæ—¶ç”¨ä¸»çº¿ç¨‹tid lockç€main queueï¼Œæ‰€ä»¥æ­¤æ—¶dq_stateå­˜ç€main thread çš„tidã€‚
2. deadLock1ä¸­ç›´æ¥åœ¨main queue sync task1æ—¶ï¼Œdq_stateå·²ç»è¢«æ‰§è¡Œtaskæ—¶æ”¹è¿‡ï¼Œæ‰€ä»¥_dispatch_queue_try_acquire_barrier_syncç›´æ¥è¿”å›falseï¼Œæ¥åˆ°_dispatch_sync_f_slowé‡Œç­‰å¾…å¹¶é˜»å¡å½“å‰çº¿ç¨‹ï¼ˆmain threadï¼‰ã€‚
3. åŒæ—¶è§¦å‘_dispatch_lock_is_locked_byæ­»é”æ£€æŸ¥ï¼Œå› ä¸ºtask1é€šè¿‡syncæäº¤ä¼šåœ¨å½“å‰ä¸»çº¿ç¨‹ä¸­æ‰§è¡Œï¼Œæ‰€ä»¥æ­¤æ—¶_dispatch_tid_self è¿”å›çš„tidä¸ºä¸»çº¿ç¨‹tidï¼Œå’Œdq_stateä¸­çš„ç›¸åŒï¼Œæ­»é”å¹¶å´©æºƒã€‚
4. deadLock2ä¸­task1åº”è¯¥åœ¨ä¸»çº¿ç¨‹ä¸­æ‰§è¡Œï¼Œä½†æ˜¯ä¼šé˜»å¡å½“å‰çº¿ç¨‹ï¼ˆmain threadï¼‰ï¼Œæ‰€ä»¥taskä»»åŠ¡ä¾ç„¶ç”¨ä¸»çº¿ç¨‹tid lockç€main queueã€‚
5. åŒæ—¶æ‰§è¡Œtask1æ—¶ï¼Œqueä¼šè¢«task1ç”¨ä¸»çº¿ç¨‹tid lockç€ï¼Œå› ä¸ºå®ƒæ˜¯ç¬¬ä¸€æ¬¡è®¾ç½®æ‰€ä»¥_dispatch_queue_try_acquire_barrier_syncè¿”å›trueï¼Œæ„å‘³ç€sync task1æ—¶ä¸ä¼šèµ°åˆ°queçš„æ­»é”æ£€æŸ¥é‡Œå»ã€‚

### âš ï¸é‡ç‚¹ç†è§£ï¼š
1. deadLock1å’ŒdeadLock2çš„æ ¹æœ¬åŒºåˆ«åœ¨äºdeadLock2é‡Œç”¨å¦ä¸€ä¸ªqueé€šè¿‡syncé˜»å¡äº†task æ”¾å¼€main queueï¼ˆmain queueçš„dq_stateè¿˜æ˜¯ä¸»çº¿ç¨‹tidï¼‰ã€‚
2. æ¯”å¦‚deadLock2 ä¸­task1å¦‚æœç”¨asyncæäº¤åˆ°queï¼Œé‚£ä¹ˆtask1ä¸é˜»å¡taskçš„æ‰§è¡Œï¼Œtaskæ‰§è¡Œå®Œåå°±æ”¾å¼€æ‰§è¡Œæ—¶ç”¨ä¸»çº¿ç¨‹tid lockç€çš„main queueã€‚æ‰€ä»¥deadLock2 é‡Œtask2çš„syncæäº¤å…¶å®æ˜¯åœ¨é‡æ–°è®¾ç½®dq_stateï¼Œæ­¤æ—¶_dispatch_queue_try_acquire_barrier_syncè¿”å›trueï¼Œæ‰€ä»¥ä¸ä¼šè§¦å‘æ­»é”æ£€æŸ¥ä¹Ÿä¸ä¼šæ­»é”ã€‚
3. è¿™é‡Œé‡æ–°è®¾ç½®dq_stateæ¯”è¾ƒç‰¹æ®Šçš„æ˜¯main queue çš„syncæäº¤æ˜¯åœ¨ä¸»çº¿ç¨‹æ‰§è¡Œï¼Œæ‰€ä»¥å®ƒçš„dq_stateè¿˜æ˜¯ä¸»çº¿ç¨‹tidï¼ˆå¦‚æœæ™®é€šä¸²è¡Œqueçš„è¯å°±è¦çœ‹å½“å‰çš„æ‰§è¡Œçº¿ç¨‹ï¼‰

åˆ¤æ–­æ­»é”å´©æºƒçš„å…³é”®ç‚¹ï¼ˆæ˜¯æ­»é”å´©æºƒğŸ˜¯ï¼‰åœ¨äºï¼Œå…ˆå‰çš„ä¸²è¡Œqueueæ˜¯å¦è¢«æŸä¸ªtaskAç”¨æ‰§è¡Œæ—¶æ‰€åœ¨çº¿ç¨‹çš„tidğŸ”’ä½ï¼Œå¦‚æœå·²ç»ğŸ”’ä½ï¼Œé‚£ä¹ˆå†å‘å®ƒsyncæäº¤taskBæ—¶ä¼šè¿›è¡Œæ­»é”æ£€æŸ¥ï¼Œå¦‚æœtaskBæ‰§è¡Œçº¿ç¨‹tidå’ŒåŸæ¥çš„ç›¸åŒå°±æ­»ğŸ”’å¹¶å´©æºƒã€‚

## æµ…å‡ºä¸¾ä¸ªå¤æ‚ğŸŒ°
``` swift
// è¾“å‡ºï¼š5ã€6ã€7å’Œ8é¡ºåºä¸å›ºå®šã€1è‚¯å®šåœ¨8åé¢ã€2è‚¯å®šåœ¨7åé¢ã€3ã€4
// âš ï¸ï¼šç”¨syncåˆ™è¾“å‡ºï¼š5ã€6ã€7å’Œ8é¡ºåºä¸å›ºå®šã€1è‚¯å®šåœ¨8åé¢ã€2è‚¯å®šåœ¨7åé¢ï¼Œmainå¾ªç¯ç­‰å¾…é˜»å¡æ­»é”å´©æºƒã€‚
func deadLock3() { //task
    let que = DispatchQueue.init(label: "thread")
    DispatchQueue.main.async { //task1
        print("1")
        que.async { //task2 //âš ï¸ï¼šå¦‚æœç”¨sync
            print("2")
            DispatchQueue.main.sync { //task3
                print("3")
            }
            print("4")
        }
    }
    print("5")
    Thread.sleep(forTimeInterval: 1.0)
    print("6")
    que.async { //task4
        print("7")
    }
    print("8")
}
```
1. task1å’Œtask4çš„æäº¤æ˜¯asyncéƒ½ä¸ä¼šé˜»å¡taskçš„æ‰§è¡Œã€‚
2. task3å‘main queue sync æäº¤æ‰§è¡Œæ—¶ï¼Œtaskè‚¯å®šæ˜¯å·²ç»å®Œæˆäº†çš„ï¼Œä»é¡ºåºå°±å¯ä»¥çœ‹å‡ºæ¥ï¼Œ3å¿…å®šåœ¨1581ä¹‹åï¼ˆè¿™é‡Œçš„ç†è§£å¾ˆå…³é”®ğŸ¤”ï¼Œä»”ç»†ä½“ä¼šï¼‰ã€‚
3. ä¸Šé¢ç¬¬2ç‚¹è¯´æ˜main queue ç°åœ¨å·²ç»æ²¡æœ‰ä»»åŠ¡ç”¨tidğŸ”’ä½å®ƒäº†ï¼Œæ‰€ä»¥task3çš„syncæäº¤æ˜¯åœ¨é‡æ–°ç”¨tidğŸ”’ä½main queueï¼Œè¿™ä¸ªtidæ˜¯ä¸»çº¿ç¨‹tidï¼Œä¸ä¼šè§¦å‘æ­»é”æ£€æŸ¥ï¼Œä¹Ÿä¸å­˜åœ¨å¾ªç¯ç­‰å¾…ä»»åŠ¡çš„æ‰§è¡Œã€‚
4. å¯¹æ¯”ç†è§£âš ï¸ä¸­ç”¨syncçš„æƒ…å†µã€‚

é€šä¿—ä¸€ç‚¹è¯´å¯ä»¥çœ‹æˆä¸²è¡Œqueueä¸­taskAæ²¡æœ‰æ‰§è¡Œå®Œï¼Œåˆå¾€queueä¸­syncä¸¢taskBï¼Œå› ä¸ºæ˜¯ä¸²è¡Œï¼Œä»»åŠ¡åªèƒ½1ä¸ªä¸ªæ‹¿å‡ºæ¥æ‰§è¡Œï¼Œæ‰€ä»¥taskBæ‰§è¡Œå®Œçš„æ¡ä»¶æ˜¯taskAæ‰§è¡Œå®Œï¼ˆAå…ˆå…¥ï¼‰ï¼Œè€ŒtaskBæ‰§è¡Œå®ŒtaskAæ‰ç®—æ‰§è¡Œå®Œå¹¶ç§»å‡ºé˜Ÿåˆ—ï¼Œæ‰€ä»¥å‡ºç°å¾ªç¯ç­‰å¾…ä»»åŠ¡ï¼Œå¯¼è‡´æ­»é”ã€‚

## å†æ·±å…¥ä¸¾ä¸ªæ­»é”æ£€æŸ¥çš„ğŸŒ°
```swift
// è¾“å‡ºï¼š1ã€2å’Œ(68)é¡ºåºä¸å›ºå®šã€3ã€queé˜Ÿåˆ—å¾ªç¯ç­‰å¾…é˜»å¡é€ æˆæ­»é”ï¼Œå¹¶ä¸ä¼šå´©æºƒã€‚
// âš ï¸ï¼šæ€è€ƒè¿™é‡Œæ¢æˆsyncçš„æƒ…å†µ
func deadLock4() {
    print("1")
    let que = DispatchQueue.init(label: "thread")
    que.async { //task1
        print("2")
        DispatchQueue.main.sync { //è¿™é‡Œç”¨syncå¯¼è‡´ç›®å‰queè¿˜æ˜¯è¢«å­çº¿ç¨‹tid lockä½
            print("3")
            que.sync { //task2
                print("4")
            }
        }
        print("5")
    }
    print("6")
    que.async { //âš ï¸ï¼šå¦‚æœè¿™é‡Œæ¢æˆsync
        print("7")
    }
    print("8")
}
```
è¿™é‡Œ4578éƒ½æ²¡æœ‰æ‰“å°å‡ºï¼Œæ¯”è¾ƒå¥½ç†è§£ï¼ˆå¯¹æ¯”æµ…å‡ºğŸŒ°ï¼‰ï¼šå› ä¸ºqueä¸­çš„task1è¢«main syncæäº¤çš„ä¸­é—´ä»»åŠ¡é˜»å¡ï¼Œtask1æ²¡æœ‰æ‰§è¡Œå®Œåˆå‘queä¸­æäº¤task2å¹¶å¸Œæœ›task2é©¬ä¸Šé˜»å¡å½“å‰çº¿ç¨‹å¹¶æ‰§è¡Œï¼Œä½†æ˜¯task1è¿˜æ²¡æ‰§è¡Œå®Œå‘¢ï¼Œæ‰€ä»¥task2ä¸å¯èƒ½æ‰§è¡Œï¼Œtask2åˆæ˜¯task1æ‰§è¡Œçš„ä¸€éƒ¨åˆ†ï¼Œæ‰€ä»¥å¾ªç¯ç­‰å¾…é˜»å¡ã€‚

ä½†æ˜¯è¿™é‡Œå¹¶ä¸ä¼šå´©æºƒğŸ¤·ğŸ¿â€â™€ï¸ğŸ¤·ğŸ¿â€â™€ï¸ğŸ¤·ğŸ¿â€â™€ï¸ï¼ŒåŸå› å¦‚ä¸‹ï¼š
1. task1ç”¨å­çº¿ç¨‹tid lockä½queï¼Œmain queueä¸Šçš„syncæäº¤é˜»å¡äº†task1æ”¾å¼€queï¼Œqueç°åœ¨ä¾ç„¶è¢«task1ç”¨å­çº¿ç¨‹tid lockä½ã€‚
2. task2è¿™é‡Œsyncä¼šåœ¨mainä¸Šæ‰§è¡Œï¼ˆsyncæ˜¯åœ¨å½“å‰çº¿ç¨‹æ‰§è¡Œä»»åŠ¡ï¼‰ï¼Œæ‰€ä»¥è¿™é‡Œtask2çš„syncæäº¤æ˜¯ç”¨ä¸»çº¿ç¨‹tidå»å’Œå·²ç»è¢«lockçš„queåšæ¯”è¾ƒï¼Œä¸æ˜¯åŒä¸€ä¸ªtidï¼Œæ‰€ä»¥ä¸ä¼šè¢«æ£€æµ‹åˆ°æ­»ğŸ”’ï¼Œä¹Ÿä¸è§¦å‘å´©æºƒã€‚

æ‰€ä»¥GCDæ­»é”çš„æ ¹æœ¬æ˜¯ä»»åŠ¡å¾ªç¯ç­‰å¾…é˜»å¡ï¼Œè€Œå´©æºƒçš„æ ¹æœ¬æ˜¯syncæäº¤æ—¶çš„æ­»é”æ£€æŸ¥ï¼Œå®é™…å¼€å‘ä¸­åº”è¯¥é¿å…è¿™ç§æƒ…å†µçš„å‡ºç°ï¼Œå› ä¸ºä¸ä¼šå´©æºƒä½†å®ƒç¡®ä¸€ç›´å ç€çº¿ç¨‹èµ„æºã€‚

âš ï¸ï¼šæ€è€ƒå¦‚æœè¿™é‡Œæ¢æˆsyncçš„æƒ…å†µåˆæ˜¯ä»€ä¹ˆå‘¢ï¼Ÿä¸ä¼šæ­»é”ã€‚

