# 第三部分Capture11：客户端识别与cookie机制 
#计算机网络/HTTP

## 11.1 用户识别机制
* 承载用户身份信息的 HTTP 首部。 
* 客户端 IP 地址跟踪，通过用户的 IP 地址对其进行识别。 
* 用户登录，用认证方式来识别用户。 
* 胖 URL，一种在 URL 中嵌入识别信息的技术。 
* cookie，一种功能强大且高效的持久身份识别技术。 

## 11.2 HTTP首部 （了解）
![](%E7%AC%AC%E4%B8%89%E9%83%A8%E5%88%86Capture11%EF%BC%9A%E5%AE%A2%E6%88%B7%E7%AB%AF%E8%AF%86%E5%88%AB%E4%B8%8Ecookie%E6%9C%BA%E5%88%B6/EB32C7F5-8472-4074-85F4-CD9E041ECBDA.png)
From、User-Agent 和 Referer 首部都不足以实现可靠的识别。 

## 11.3 客户端IP地址（了解） 
如果每个用户都有不同的 IP 地址，IP 地址(如果会发生变化的话)也很少会发生变化，而且 Web 服务器可以判断出每条请求的客户端 IP 地址的话，这种方案是可行的，但是有如下缺点：

* 客户端 IP 地址描述的是所用的机器，而不是用户。如果多个用户共享同一台计 算机，就无法对其进行区分了。 
* 很多因特网服务提供商都会在用户登录时为其动态分配 IP 地址。用户每次登录 时，都会得到一个不同的地址，因此 Web 服务器不能假设 IP 地址可以在各登录 会话之间标识用户。 
* 为了提高安全性，并对稀缺的地址资源进行管理，很多用户都是通过网络地址转 换(Network Address Translation，NAT)防火墙来浏览网络内容的。这些 NAT 设备隐藏了防火墙后面那些实际客户端的 IP 地址，将实际的客户端 IP 地址转换 成了一个共享的防火墙 IP 地址(和不同的端口号)。 
* HTTP 代理和网关通常会打开一些新的、到原始服务器的 TCP 连接。Web 服务 器看到的将是代理服务器的 IP 地址，而不是客户端的。有些代理为了绕过这个 问题会添加特殊的 Client-IP 或 X-Forwarded-For 扩展首部来保存原始的 IP 地址(参见图 11-1)。但并不是所有的代理都支持这种行为。 

## 11.4 用户登录
通过用户名和密码进行认证(登录)来显式地询问用户是谁 。HTTP 中包含了一种内建机制，可以用 WWW- Authenticate 首部和 Authorization 首部向 Web 站点传送用户的相关信息。 

![](%E7%AC%AC%E4%B8%89%E9%83%A8%E5%88%86Capture11%EF%BC%9A%E5%AE%A2%E6%88%B7%E7%AB%AF%E8%AF%86%E5%88%AB%E4%B8%8Ecookie%E6%9C%BA%E5%88%B6/8520B13D-2358-4C64-8831-7743A80BF1B2.png)
a：浏览器对站点 www.joes-hardware.com 发起了一条请求。 
b：站点并不知道这个用户的身份，服务器会返回 401 Login Required HTTP 响应码，并添加 WWW-Authentication 首部，要求用户登录。 
c：用户输入了用户名和密码(对其身份进行完整性检查)，浏览器就会重复原 来的请求，并添加一个 Authorization 首部，说明用户名和密码。对用户名和密码进行加密（实际上很容易破解）。 
d：今后的请求要使用用户名和密码时，浏览器会自动将存储下来的值发送出去，在每次请求中都向服务器发送 Authorization 首部作为一种身份的标识，这样只要登录一次，就可以在整个会话期间维持用户的身份了。 

## 11.5 胖URL（了解）
对真正的 URL 进行扩展，在 URL 路径开始或结束的地方添加一些状态信息。用户浏 览站点时，Web 服务器会动态生成一些超链，继续维护 URL 中的状态信息。

胖 URL 将 Web 服务器上若干个独立的 HTTP 事务捆绑成一个“会话”或 “访问”。用户首次访问这个 Web 站点时，会生成一个唯一的 ID，用服务器可以识 别的方式将这个 ID 添加到 URL 中去，然后服务器就会将客户端重新导向这个胖 URL。不论什么时候，只要服务器收到了对胖 URL 的请求，就可以去查找与那个用 户 ID 相关的所有增量状态(购物车、简介等)，然后重写所有的输出超链，使其成 
为胖 URL，以维护用户的 ID。

*存在如下问题：*
* 丑陋的 URL
浏览器中显示的胖 URL 会给新用户带来困扰。 
* 无法共享 URL
胖 URL 中包含了与特定用户和会话有关的状态信息。如果将这个 URL 发送给其 他人，可能就在无意中将你积累的个人信息都共享出去了。 
* 破坏缓存
为每个 URL 生成用户特有的版本就意味着不再有可供公共访问的 URL 需要缓存了。 
* 额外的服务器负荷
服务器需要重写 HTML 页面使 URL 变胖。 
* 逃逸口
用户跳转到其他站点或者请求一个特定的 URL 时，就很容易在无意中“逃离” 胖 URL 会话。只有当用户严格地追随预先修改过的链接时，胖 URL 才能工作。 如果用户逃离此链接，就会丢失他的进展(可能是一个已经装满了东西的购物 车)信息，得重新开始。 
* 在会话间是非持久的
除非用户收藏了特定的胖 URL，否则用户退出登录时，所有的信息都会丢失。 

## 11.6 cookie （重点掌握）
*cookie 是当前识别用户，实现持久会话的最好方式*。前面各种技术中存在的很多问 题对它们都没什么影响，但是通常会将它们与那些技术共用，以实现额外的价值。 cookie 最初是由网景公司开发的，但现在所有主要的浏览器都支持它。 

*cookie 非常重要，而且它们定义了一些新的 HTTP 首部，cookie 的存在也影响了缓存，大多数缓存和浏览器都不允许对任何 cookie 的内容进行缓存* 

### 11.6.1 cookie的类型 
*会话 cookie：* 是一种临时 cookie。它记录了用户访问站点时的设置和偏好。用户退出浏览器时，会话 cookie 就被删除了。
*持久 cookie：* 生存时间更长一些。它们存储在硬盘上，浏览器退出，计算机重启时它们仍然存在。 

> 如果设置了 Discard 参数，或者没有设置 Expires 或 Max-Age 参数来说明扩展的过期时间，这个 cookie 就是一个会话 cookie。   

### 11.6.2 cookie的工作原理
基本思想就是让浏览器积累一组服务器特有的信息，每次访问服务器时都将这些信息提供给它。

用户首次访问 Web 站点时，Web 服务器会通过 Set-Cookie 或 Set-Cookie2 HTTP 响应(扩展)首部给这个用户“拍上”一个独有的 cookie用来识别出这个用户。浏览器会记住从服务器返回的 Set-Cookie 或 Set-Cookie2 首部中的 cookie 内 容，并将 cookie 集存储在浏览器的 cookie 数据库中。将来用户返回同一站点时，浏览器会挑中那个服务器贴到用户上的那些 cookie，并在一个 cookie 请求首部中将其传回去。 
![](%E7%AC%AC%E4%B8%89%E9%83%A8%E5%88%86Capture11%EF%BC%9A%E5%AE%A2%E6%88%B7%E7%AB%AF%E8%AF%86%E5%88%AB%E4%B8%8Ecookie%E6%9C%BA%E5%88%B6/9B540450-389A-46E6-A728-F4A5A91AA2B1.png)

> cookie 中包含了一个由名字 = 值(name=value) 这样的信息构成的任意列表  
> cookie 中可以包含任意信息，但它们通常都只包含一个服务器为了进行跟踪而产 生的独特的识别码。   
 
11.6.3 cookie罐:客户端的状态 
cookie 的基本思想就是让浏览器积累一组服务器特有的信息，每次访问服务器时都将这些信息提供给它。因为浏览器要负责存储 cookie 信息，所以此系统被称为客户端侧状态(client-side state)。 

11.6.4 不同站点使用不同的cookie  
浏览器只向服务器发送服务器产生的那些 cookie。cookie 中包含的是服务器特有的名值对，所以对大部分站点来说，大多数 cookie 都只是无法识别的无用数据。

很多Web 站点都会与第三方厂商达成协议，由其来管理广告。这些广告被做得像 Web 站点的一个组成部分，而且它们确实发送了持久 cookie。用户访问另一个由同 一广告公司提供服务的站点时，(由于域是匹配的)浏览器就会再次回送早先设置的 持久 cookie。### 营销
公司可以将此技术与 Referer 首部结合，暗地里构建一个用户档 案和浏览习惯的详尽数据集。现代的浏览器都允许用户对隐私特性进行设置，以限 制第三方 cookie 的使用。 

11.6.5 cookie成分 
现在使用的 cookie 规范有两个不同的版本：
cookies 版本 0(有时被称为 Netscape cookies) 
cookies 版本 1(RFC 2965) 

11.6.8 cookie与会话跟踪 
电子 商务 Web 站点用会话 cookie 在用户浏览时记录下用户的购物车信息 
。在浏览器中输入 http://www.amazon.com 时，就启 动了一个事务链，在这些事务中 Web 服务器会通过一系列的重定向、URL 重写以 及 cookie 设置来附加标识信息。 

![](%E7%AC%AC%E4%B8%89%E9%83%A8%E5%88%86Capture11%EF%BC%9A%E5%AE%A2%E6%88%B7%E7%AB%AF%E8%AF%86%E5%88%AB%E4%B8%8Ecookie%E6%9C%BA%E5%88%B6/EB0248D7-76AC-4F09-A9C7-9FF759EEFF3E.png)
* 图 11-5a——浏览器首次请求 Amazon.com 根页面。 
* 图 11-5b——服务器将客户端重定向到一个电子商务软件的 URL 上。 
* 图 11-5c——客户端对重定向的 URL 发起一个请求。 
* 图 11-5d——服务器在响应上贴上两个会话 cookie，并将用户重定向到另一个 URL，这样客户端就会用这些附加的 cookie 再次发出请求。这个新的 URL 是个 胖 URL，也就是说有些状态嵌入到 URL 中去了。如果客户端禁止了 cookie，只 要用户一直跟随着 Amazon.com 产生的胖 URL 链接，不离开网站，仍然可以实 现一些基本的标识功能。 
* 图 11-5e——客户端请求新的 URL，但现在会传送两个附加的 cookie。 
* 图 11-5f——服务器重定向到 home.html 页面，并附加另外两个 cookie。
* 图 11-5g——客户端获取 home.html 页面并将所有四个 cookie 都发送出去。 
* 图 11-5h——服务器回送内容。 








 

 










