# IP协议
#计算机网络/TCPIP

![](IP%E5%8D%8F%E8%AE%AE/E68EE7B3-A5F9-4188-82D1-1710FFD37F22.png)
网络层主要作用是完成IP主机到IP主机间的通讯，其中会跨越多个数据链路。数据链路层完成的是在同一个数据链路上帧的传递。

# 网络层和数据链路层的关系理解
![](IP%E5%8D%8F%E8%AE%AE/A8A8EA2D-B10A-4613-A4C3-11D3A61B6589.png)
数据链路层完成完成数据的实际传送，网络层路由器安排在不同数据链路层间通讯传递数据时选择哪种路径。

# IP地址的理解和作用？
![](IP%E5%8D%8F%E8%AE%AE/E3E65598-63D0-4340-9D72-8F202B92080E.png)

![](IP%E5%8D%8F%E8%AE%AE/5587EF29-F0F6-4F47-974F-7EC0AA6C7D33.png)

# 理解IP协议？
![](IP%E5%8D%8F%E8%AE%AE/F1610B26-4D9D-499B-B8B0-0DFBC5736DD1.png)

# IP 首部
![](IP%E5%8D%8F%E8%AE%AE/26ACD45E-BEFE-4638-A10B-649D93E719EC.png)

# 首部字段和注意点
![](IP%E5%8D%8F%E8%AE%AE/DE5F4E23-1921-4790-9D8D-01684BC514E4.png)

![](IP%E5%8D%8F%E8%AE%AE/9BFD2C82-0BAC-46F8-BDCD-1DBD5D2E818B.png)
重点注意这里首部长度信息里1表示4个bety。

![](IP%E5%8D%8F%E8%AE%AE/EFCE1769-A609-4A2F-87DD-E765CE1D6F4A.png)
![](IP%E5%8D%8F%E8%AE%AE/87A806F0-C6E8-4FC3-B753-F0DE13592004.png)
![](IP%E5%8D%8F%E8%AE%AE/EA4BEB3B-68DB-4A16-A08E-78E50050812E.png)
早先是为了表明服务质量设计了8个位的TOS，但是现在几乎所有网络都无视TOS这三个位。
但是前面3个IP优先级位是有在用的，越小表示包越不重要，一般用来做Qos，比如某个包进入内部网络的时候打上Qos优先级标志位，中间设备基于标志位的标识进行不同的Qos优先级处理。

后来觉得Qos优先级只有3位太少了，无法进行复杂的处理，所以把这8个位重新分成了DSCP段、ECN段，
前6位DSCP同时兼容了原来的划分，便于更精细的进行Qos的控制。
后2位ECN是用来显示拥塞通告的。

*ECN的应用原理*
牵扯到TCP和IP，TCP首部里面有CWR、ECE位。
首先在TCP握手的时候会协商2端是否都支持ECN位。
当一个支持ECN的10包穿过某个路由并遇到拥塞时，路由器将这个包的ECN位改为11，标识发生了拥塞，接收端收到后看到ECN为11则通过设置TCP头部ECE标志位为1回一个包给源端告诉它IP告诉我这个包差点被丢了，只是路由器放过了，你要发慢一点。
源端收到TCP首部ECE标志位为1的包则知道网络中出现了拥塞，TCP会调低滑动窗口，降低发送速度，成功降低后会回一个包并把TCP首部CWR标志位置为1告诉接收端我已经慢了。
![](IP%E5%8D%8F%E8%AE%AE/DADBC744-1C5A-4B2B-8D1C-C085077E3DD2.png)

![](IP%E5%8D%8F%E8%AE%AE/4FB71383-B7AF-40F0-9160-DDCBF9ED1C4F.png)
总长度字段占16位，数据包总长度最大支持2的16次方，但是数据链路上一般不支持传输这么大的包，所以IP会进行分片处理。
标识位占16位，用于重组分片，来自于同一个包的分片标识相同。

![](IP%E5%8D%8F%E8%AE%AE/3E8EE74B-CEDD-491A-9205-3CB4C535F0A9.png)
标志位占3位，第0位保留，第2位标志能否分片，第三位表示是否是最后一个分片包。
片偏移位占13位，标识分片在原包内的相对位置用于分片重组，因为只有13位无法表示最大分片偏移长度65536，所以单位为8个子节。

![](IP%E5%8D%8F%E8%AE%AE/5E69CF17-9F85-4C22-9D33-6CC3E5B5A24C.png)
TTL位占8位，标示最大生存时间，每过一个路由器-1，到0就丢弃。
协议号占8位，标示IP首部的一下个首部隶属于哪个协议，比如TCP。、

![](IP%E5%8D%8F%E8%AE%AE/4EDDCC44-89A8-42CD-9C9E-AB6F9FB93299.png)
首部校验和占16位，::用来标示IP数据报首部是否被修改过。::  

![](IP%E5%8D%8F%E8%AE%AE/6028F54C-71A5-42FD-A53A-9667EFDE9A5C.png)
可选项最大40个字节，首部长度4位，单位为4，最大为15，标示最大首部长度为60bety，前面其他首部占用20个字节，所以可选项最多40个字节。

填充就是首部长度不为4字节倍数时需要补齐。

# 命令
ifconfig：查看IP信息
netstat -r ：查看路由表
![](IP%E5%8D%8F%E8%AE%AE/3A0039BD-93F5-498E-B0BC-AB4128B3A957.png)