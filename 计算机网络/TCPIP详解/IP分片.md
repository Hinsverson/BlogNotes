# IP分片
#计算机网络/TCPIP

# IP分片注意点
![](IP%E5%88%86%E7%89%87/527279C6-FA42-4225-867A-38033A055C3B.png)
MTU大小和数据链路入端口大小有关，每个链路可能不同，所以分片也可能发生在中间路由器上。
IP分片的组装只有在目的地后才会组装。
重组依据是每个分片IP首部中的总长度和偏移信息。

![](IP%E5%88%86%E7%89%87/BC7CEC40-0523-4DAA-BD76-CA10D47BE062.png)
![](IP%E5%88%86%E7%89%87/EA9F92E4-0C30-499C-B5A4-057389C66B25.png)
![](IP%E5%88%86%E7%89%87/5ED0BA47-8A43-4BCF-8C37-3A89EB4EB411.png)

# IP分片实例
![](IP%E5%88%86%E7%89%87/B790EB42-E1D9-4C66-84C2-0ACCAD839B71.png)
R1的MTU为1500，R2为1000
![](IP%E5%88%86%E7%89%87/80B76882-C518-46AB-B7E6-596460D339B4.png)
注意IP首部里片偏移单位是8bety，所以分片的数据包负载部分大小必须是8的倍数，第二个路由器最大MTU虽然为1000，但是由于-20首部=980不能被8整除，所以选了一个最大的能被8整数的976作为分片大小。

# MTU的理解
![](IP%E5%88%86%E7%89%87/0F460489-ED2E-487E-B5EE-73EE930DC091.png)
一般VPN设备会有专门的Path MTU发现探测机制寻找最小MTU，避免分片，因为分片效率低，而且一但丢失一片，在保证可靠的上层就必须要重发。

**Path MTU 探测原理**
![](IP%E5%88%86%E7%89%87/3AFB8830-844D-4D23-B236-637EF055AB6B.png)
首先把IP包标志位置置为1表示不能分片，发送一个1500大小的探测包，如果经过路由MTU比它小，会回一个错误包附带MTU信息，拿到这个信息更新发送包的大小，如果还是收到错误包，则继续根据MTU信息更新包大小，直到数据成功发送，就能获取到Path MTU。